
```{r, echo=F, include=F}
library(tidyverse) 
library(tidycensus)
library(sf)
library(tigris)
library(maps)
library(tmap)
#install.packages('ggnewscale')
library(ggnewscale)
#install.packages("colorspace")
library(colorspace)
```

```{r, echo=F, include=F}
stops = read_csv('stop_features.csv')
stop_locations = read_csv('data/stop_features_locations.csv')
```

```{r, echo=F}
high_max = stops %>% filter(day == 0) %>% filter(stop_type == 'MAX Station') %>% arrange(desc(total_usage)) %>% head(5)
#high_max
```


```{r, echo=F}
high_max_lat = data.frame('lat'=c(45.530269, 45.435721, 45.519253, 45.587584, 45.530057))
high_max_lon = data.frame('long'=c(-122.563578, -122.567769, -122.679475, -122.5931, -122.664917))
high_max = high_max %>% cbind(high_max_lat, high_max_lon)
```


```{r, echo=F}
high_bus = stops %>% filter(day == 0) %>% filter(stop_type == 'Bus Station') %>% arrange(desc(total_usage)) %>% head(5)
#high_bus
```

```{r, echo=F}
high_bus_lat = data.frame('lat'=c(45.490746, 45.437504, 45.49093, 45.435666, 45.5299))
high_bus_lon = data.frame('long'=c(-122.801309, -122.574003, -122.801741, -122.568707, -122.563177))
high_bus = high_bus %>% cbind(high_bus_lat, high_bus_lon)
```


```{r, echo=F}
low_max = stops %>%
  filter(total_usage > 0) %>% filter(stop_type == 'MAX Station') %>% filter(day == 0) %>%
  arrange(total_usage) %>% head(5)
#low_max
```

```{r, echo=F}
low_max_lat = data.frame('lat'=c(45.510483, 45.430321, 45.474312, 45.468462, 45.474182))
low_max_lon = data.frame('long'=c(-122.7173, -122.635561, -122.640158, -122.567216, -122.63978))
low_max = low_max %>% cbind(low_max_lat, low_max_lon)
```

```{r, echo=F}
low_bus = stops %>%
  filter(total_usage > 0) %>% filter(stop_type == 'Bus Station') %>% 
  arrange(total_usage) %>% head(5)
#low_bus
```

```{r, echo=F}
low_bus_lat = data.frame('lat'=c(45.470914, 45.585828, 45.589606, 45.589573, 45.599807))
low_bus_lon = data.frame('long'=c(-122.693601, -122.706898, -122.680115, -122.683481, -122.676919))
low_bus = low_bus %>% cbind(low_bus_lat, low_bus_lon)
```

```{r, echo=F}
max_usage = rbind(high_max, low_max) %>% 
  select(stop_id, stop_name, total_usage, lat, long) %>% 
  filter(stop_name != 'Gateway/NE 99th Ave TC MAX Station')
  #mutate(long = abs(long))
bus_usage = rbind(high_bus, low_bus) %>% 
  select(stop_id, stop_name, total_usage, lat, long) #%>% 
  #mutate(long = abs(long))
```

```{r, echo=F, include=F}
orwa <- rbind_tigris(
  tracts("OR", cb = TRUE), 
  tracts("WA", cb = TRUE)
)
```


```{r echo=FALSE, include=F}
census_api_key("b68945413daec2c8b9c203e226f58f5fa9eaa6f5", overwrite=TRUE)
```

```{r, echo=F, include=F}
mult_pop <- get_acs(geography = "tract", 
               state = "OR", county = "Multnomah",
               variables = "B02001_001", 
               geometry = TRUE)

wa_pop = get_acs(geography = "tract", 
               state = "OR", county = "Washington",
               variables = "B02001_001", 
               geometry = TRUE)

clack_pop = get_acs(geography = "tract", 
               state = "OR", county = "Clackamas",
               variables = "B02001_001", 
               geometry = TRUE)

pdx_pop = rbind(mult_pop, wa_pop, clack_pop)

pdx_pop_gg = orwa %>% st_join(pdx_pop)
```

# Discussion

## Project Overview

Over the course of this project, we went through the data collection and engineering process as well as modeled usage using statistical and machine learning-based regressions. Two types of data were collected from the TriMet website: usage information by station for Spring 2025, and schedule information for each station. These values were uploaded into a publicly-available database, as well as transformed into a number of features that were used in predicting the usage value of a station. 

We used this data to create a number of statistical and machine learning models. From these models, we were able to learn that our features had measurable effects on station usage, and that we could use these features to predict usage with relatively high accuracy. 

Our Quasi-Poisson models provided a number of insights into what features have effects on TriMet station usage. We found that a number of our features had positive effects on usage, and a number of them had negative effects on usage. Some of the most salient was the decrease in usage on weekend days, and the fact that adding an additional route to a station increases its usage by 20%. We also discovered that for each additional minute there is not an arrival at a station, the station's usage drops by about 5%. 

We created a number of machine learning models that predicted station usage from the features engineered for this data set. The best model we found, a random forest, had a test RMSE of 0.685 and an $R^2$ value of 0.523. This model is further illustrated in @fig-ml. The model consistently over-predicted values in the low-usage range and under-predicted values in the high-usage range. The low-usage overprediction is likely a result of the log-transform (as can be seen in @fig-ml). Overall, this model can be used to provide estimates, but it would benefit from adding features such as location data to improve prediction accuracy. 

## Future Work 

In some ways, it is not a surprise that schedule data alone does not account for all the features driving usage of TriMet stations. Future work done on the question explored in this project would benefit highly from the inclusion of accurate location data for each station stop, which was unfortunately not easily available within the timeframe of this project. Potential features included alongside location data could be those that provide context to the area the station is located in by answering questions such as: 

* How many people live within a certain radius? 
* Is this station part of a transit center? 
* Is there parking available nearby?
* How close is this station to frequently-visited areas, such as parks or grocery stores? 

Answers to these questions and others like them would allow for a holistic understanding of the station, rather than focusing on the schedule as set up by TriMet. 

### Location Proof of Concept

We were able to conduct a small amount of preliminary analysis that indicates location data would be a meaningful predictor in future models. 

Another capstone group kindly allowed us to use their data that provides coordinates for intersections in downtown Portland, which we cross-referenced with our stations that had names in "Street Name & Street Name" format. There were 4,706 stations with names in this format that overlapped with the reference table. Unfortunately, the cross-referencing strategy used was not particularly reliable, and as such stations were not always assigned the correct coordinates. This particular location dataset had minimal, if any, effect on models trained using it alongside our engineered features. However, we were able to use this location data to produce @fig-loc-map, below, which shows that high-usage stations are often clustered together. This leads us to believe that a correctly-gathered location dataset would in fact make a good predictor in future models. 

```{r, echo=F}
#| label: fig-loc-map
#| fig-cap: 'A map of bus station usage by location, using our cross-referenced location dataset. While this dataset was not reliable enough to be used in the models constructed for this project, it can be used to show that high-usage stations are clustered in specific areas, and potentially even along specific lines.'
ggplot() + 
  geom_sf(data=orwa, fill=NA) + 
  #geom_sf(data=pdx_pop_gg, aes(fill=estimate))+
  # sort by value--high on top 
  geom_point(data=stop_locations %>% filter(total_usage < 50), aes(x=long, y=lat, color=total_usage))+
  geom_point(data=stop_locations %>% filter(total_usage > 50), aes(x=long, y=lat, color=total_usage))+
  geom_point(data=stop_locations %>% filter(total_usage > 200), aes(x=long, y=lat, color=total_usage))+
  geom_point(data=stop_locations %>% filter(total_usage > 250), aes(x=long, y=lat, color=total_usage))+
  geom_point(data=stop_locations %>% filter(total_usage > 300), aes(x=long, y=lat, color=total_usage))+
  xlim(-122.78, -122.47) + 
  ylim(45.43, 45.65) +
  scale_color_continuous(type='viridis', name='Total Usage', direction=-1) + 
  theme_bw() +
  labs(
    title='Bus Station Usage by Location', 
    subtitle='Made Using Location Data Subset',
    caption = 'Data from TriMet and OpenStreetMap'
  ) + 
  theme(
    axis.title.x = element_blank(), 
    axis.title.y = element_blank()
  )
  
```

In the later stages of our analysis, we found that there is in fact a way to extract TriMet stop locations from the maps provided on the TriMet website. Accessing this data was too complex to be a feasible webscrape within the time restrictions of this project, but we manually extracted the locations of the 5 highest- and lowest-usage MAX and bus stations in the TriMet system. This resulted in a dataset of 20 stations with location information. This dataset was combined with census tract population data retrieved from the 2024 American Community Survey [@acs] to produce @fig-loc-pop. It can be seen that population has an effect on transit usage: the cluster of high-usage stations of both types in the bottom left of @fig-loc-pop at the Clackamas Town Center are very near to a high-population area. It can also be seen that most of the lowest-usage bus stations are clustered together in a relatively low-population census tract, in the north of this map. Additionally, two of the highest-usage MAX stations are close together in the Portland downtown. @fig-loc-pop provides a compelling argument for the inclusion of location and neighborhood context data in any future investigation of this topic. 

```{r, echo=F}
#| label: fig-loc-pop
#| fig-cap: 'The top 5 highest- and lowest-usage MAX stations (squares) and bus stations (triangles), overlaid on census tract population estimates from the 2024 ACS. High-usage stations are labelled with their station name. The clusters of high- and low-usage stations provide a compelling argument for location data and neighborhood population as meaningful predictors for usage.'
ggplot() + 
  geom_sf(data=orwa, fill='lightblue') + 
  geom_sf(data=pdx_pop_gg, aes(fill=estimate))+
  scale_fill_continuous_sequential('Light Grays', name='Population', guide = guide_colorbar(theme = theme(
      legend.direction = "horizontal",
      legend.title.position = "top",
      legend.text.position = "bottom"#,
      #legend.text = element_text(angle = 90)
    ))) + 
  new_scale_fill() + 
  geom_point(data=max_usage, aes(x=long, y=lat, fill=total_usage), shape=22)+ 
  scale_fill_continuous_sequential('YlOrRd', name='MAX Usage', guide = guide_colorbar(theme = theme(
      legend.direction = "horizontal",
      legend.title.position = "top",
      legend.text.position = "bottom"
      ))) + 
  geom_text(data=max_usage, aes(x=long, y=lat, label=ifelse(total_usage>500,as.character(stop_name),'')), hjust=0.5, vjust=1, size=3.25, check_overlap=T)+
  xlim(-122.9, -122.4) + 
  ylim(45.4, 45.62) +
  new_scale_fill() + 
  geom_point(data=bus_usage, aes(x=long, y=lat, fill=total_usage), shape=24)+ 
  scale_fill_continuous_sequential('GnBu', name='Bus Usage' ,guide = guide_colorbar(theme = theme(
      legend.direction = "horizontal",
      legend.title.position = "top",
      legend.text.position = "bottom"
    ))) + 
  geom_text(data=bus_usage, aes(x=long, y=lat, label=ifelse(total_usage>500,as.character(stop_name),'')), hjust=0.5, vjust=-1, size=3.25, check_overlap=T)+
  #coord_sf(default_crs = sf::st_crs(4326)) + 
  theme_minimal() + 
  labs(
    x='', 
    y='', 
    caption = 'Data from TriMet and the 2024 ACS', 
    title = 'Highest and Lowest 5 Bus and MAX Station Usage by Location', 
    subtitle='Compare to Census Tract Populations'
  ) + 
  theme(legend.direction='horizontal', legend.box='vertical', 
        axis.title.x = element_blank(), 
      axis.title.y = element_blank()
        )
  
```

## In Conclusion

This report provides a publicly-available analysis of TriMet usage data. We provide a publicly-available database of TriMet usage data by station for Spring 2025, which also includes schedule information for each station. This data was used to engineer a number of features that were used in statistical models to determine their effect on usage, as well as predict station usage with relatively high accuracy. The database as well as features engineered in this project provide a strong starting point for future work. We believe future work that provides information such as location data and neighborhood context to stations is likely to improve these models' ability to predict TriMet station usage, and be used to determine where a station could be added or which routes should run more often to result in higher usage. 
