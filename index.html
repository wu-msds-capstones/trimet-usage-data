<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Trimet Usage Data: the Impact of Schedule on Usage</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-1c59215f878e034bd7426c637fa661ac.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">


<meta name="citation_title" content="Trimet Usage Data: the Impact of Schedule on Usage">
<meta name="citation_author" content="Kaiden Elam">
<meta name="citation_author" content="Denton Kunz">
<meta name="citation_language" content="en">
<meta name="citation_reference" content="citation_title=A guide to backward paper writing for the data sciences;,citation_abstract=Summary In this perspective, we outline a set of best practices for the planning, writing, and revision of scientific papers and other forms of professional communication in the data sciences. We propose a backward approach that begins with clearly identifying the scientific and professional goals motivating the work, followed by a purposeful mapping from those goals to each section of a paper. This approach is motivated by the conviction that manuscript writing can be more effective, efficient, creative, and even enjoyable—particularly for early-career researchers—when the overarching goals of the paper and its individual components are clearly mapped out.;,citation_author=Jon Zelner;,citation_author=Kelly Broen;,citation_author=Ella August;,citation_publication_date=2022;,citation_cover_date=2022;,citation_year=2022;,citation_fulltext_html_url=https://www.sciencedirect.com/science/article/pii/S2666389921003068;,citation_issue=3;,citation_doi=10.1016/j.patter.2021.100423;,citation_issn=2666-3899;,citation_volume=3;,citation_journal_title=Patterns;">
</head>

<body class="quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Trimet Usage Data: the Impact of Schedule on Usage</h1>
            <p class="subtitle lead">Willamette MSDS Capstone Project 2025</p>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
        
        <div class="quarto-title-meta">

                <div>
            <div class="quarto-title-meta-heading">Authors</div>
            <div class="quarto-title-meta-contents">
                        <p>Kaiden Elam </p>
                        <p>Denton Kunz </p>
                      </div>
          </div>
                
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>



    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#a-note-on-terminology" id="toc-a-note-on-terminology" class="nav-link" data-scroll-target="#a-note-on-terminology">A Note on Terminology</a></li>
  </ul></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  <li><a href="#ethical-considerations" id="toc-ethical-considerations" class="nav-link" data-scroll-target="#ethical-considerations">Ethical Considerations</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a>
  <ul class="collapse">
  <li><a href="#data-collection-and-manipulation" id="toc-data-collection-and-manipulation" class="nav-link" data-scroll-target="#data-collection-and-manipulation">Data Collection and Manipulation</a>
  <ul class="collapse">
  <li><a href="#pdf-data-extraction-and-webscraping" id="toc-pdf-data-extraction-and-webscraping" class="nav-link" data-scroll-target="#pdf-data-extraction-and-webscraping">PDF Data Extraction and Webscraping</a></li>
  <li><a href="#database-construction" id="toc-database-construction" class="nav-link" data-scroll-target="#database-construction">Database Construction</a></li>
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">Feature Engineering</a></li>
  </ul></li>
  <li><a href="#statistical-modeling" id="toc-statistical-modeling" class="nav-link" data-scroll-target="#statistical-modeling">Statistical Modeling</a></li>
  <li><a href="#machine-learning" id="toc-machine-learning" class="nav-link" data-scroll-target="#machine-learning">Machine Learning</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a>
  <ul class="collapse">
  <li><a href="#statistical-modeling-1" id="toc-statistical-modeling-1" class="nav-link" data-scroll-target="#statistical-modeling-1">Statistical Modeling</a></li>
  <li><a href="#machine-learning-1" id="toc-machine-learning-1" class="nav-link" data-scroll-target="#machine-learning-1">Machine Learning</a></li>
  </ul></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a>
  <ul class="collapse">
  <li><a href="#future-work" id="toc-future-work" class="nav-link" data-scroll-target="#future-work">Future Work</a></li>
  <li><a href="#in-conclusion" id="toc-in-conclusion" class="nav-link" data-scroll-target="#in-conclusion">In Conclusion</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">




  


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Portland is rated one of the most walkable cities in the United States. However, the United States has famously worse walkability and public transit than many other developed countries. Namely, Japan and the Netherlands have state-of-the-art public transportation systems. To better understand how we could improve public transit in Portland, we explored Trimet data. We wanted to use data science to answer the question, “What qualities of TriMet transit stops and routes affect their usage numbers?” In understanding the factors behind station and route usage, we should be able to uncover potential locations for new stations.</p>
<p>In this paper, we will gather, transform, and organize publicly available Trimet data. We will perform both statistics and machine learning to answer our question and explore the data.</p>
<section id="a-note-on-terminology" class="level3">
<h3 class="anchored" data-anchor-id="a-note-on-terminology">A Note on Terminology</h3>
<p>For clarity throughout this paper, we will define any stop along a route as a “station”. Additionally, each route is defined as a series of stations going a specific direction on a specific day. For example, a series of stations running on a weekday is considered a different route from a series of stations running on the weekend.</p>
</section>
</section>
<section id="background" class="level1">
<h1>Background</h1>
<p>Recent studies specific to Portland public transit include investigating effects of COVID on public transit demand, effects of public transit on physical activity, effects on ridesharing and biking, effects on employment, equity-advancing practices, and more. However, this study focuses specifically on TriMet and the qualities and features of TriMet stops. Therefore, any similar previous studies have likely been done by TriMet themselves. Our research is certainly not more in-depth than TriMet’s, since they have easier access to their own data. We hope to provide a publicly available inquiry into TriMet’s data.</p>
</section>
<section id="ethical-considerations" class="level1">
<h1>Ethical Considerations</h1>
<p>Access to public transit can lead to difficult ethical considerations. Neighborhoods with historically underprivileged populations are often the ones that rely most on public transit, but are also those that are least likely to receive transit stations within a usable distance. The idea of what counts as a “usable distance” is itself a difficult question to answer ethically. This can even vary for the same person over time–walking for 10 minutes on the way to work might be a nice part of the commute, even in the rain, but becomes a slog when hauling luggage to the airport. A distance that takes one person ten minutes to walk may take someone else a half hour, and they have no energy to do errands once they’ve arrived at the bus stop. These are not easy considerations to make, and yet they are crucial ones. Transit centers can get around this issue somewhat by providing parking, but that still requires someone to have a car in order to get to the transit center to take a transit route–or requires having a larger number of local transit routes that feed into the transit center from the surrounding area. These are only a few of the ethical considerations that must go into designing a transit system, and yet those listed so far are outside the scope of this project. We do have one variable, however, that may raise a few ethical questions: the average number of minutes between arrival times at a station. Boxplots are provided for this variable, separated by station type in the TriMet system, in Figure 1. A zoomed-in version of these plots is provided in Figure 2.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="capstone_files/figure-html/unnamed-chunk-3-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure 1: Boxplots showing the average number of minutes between arrivals at a station, faceted by each station type. Data from both weekdays and weekend days is included."><img src="capstone_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672" alt="Figure 1: Boxplots showing the average number of minutes between arrivals at a station, faceted by each station type. Data from both weekdays and weekend days is included."></a></p>
<figcaption>Figure 1: Boxplots showing the average number of minutes between arrivals at a station, faceted by each station type. Data from both weekdays and weekend days is included.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="capstone_files/figure-html/unnamed-chunk-4-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure 2: Boxplots showing the average number of minutes between arrivals at a station, faceted by each station type. Data from both weekdays and weekend days is included. Outliers higher than 100 are excluded for a better view of the non-outlier data."><img src="capstone_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672" alt="Figure 2: Boxplots showing the average number of minutes between arrivals at a station, faceted by each station type. Data from both weekdays and weekend days is included. Outliers higher than 100 are excluded for a better view of the non-outlier data."></a></p>
<figcaption>Figure 2: Boxplots showing the average number of minutes between arrivals at a station, faceted by each station type. Data from both weekdays and weekend days is included. Outliers higher than 100 are excluded for a better view of the non-outlier data.</figcaption>
</figure>
</div>
</div>
</div>
<p>This variable was calculated by collecting all the arrivals at a station and averaging the differences between them, so stops that are only active during a certain time of day are penalized by that. For example, the WES trains only run during rush hour, with a large gap in the middle of the day, so there is one artificially large value. Overall, however, most routes run consistently throughout the day and the values shown should be reflective of standing at a station waiting for a transit line to arrive as scheduled. Consider how long you would be willing to stand at a transit station waiting if you watched the previous vehicle stop at the station from across the street and leave without you on it. It’s likely you picked about 20 minutes. However, it can be seen in Figure X that only the MAX lines run every 15-20 minutes regularly, and that only half of the buses by quartile are 25 minutes or less. The third quartile of the bus stations goes up over 60 minutes. More than an hour is a long time to wait at a transit stop. This illustrates just one of many ethical considerations that must be taken into account when designing a transit system–or even simply running one, as TriMet is doing.</p>
</section>
<section id="data" class="level1">
<h1>Data</h1>
<p>The final dataset constructed for the analysis done in this project is a combination of the usage and schedule raw data files, described in the next section. It has 9 columns, five of which are independent variables. The unit of interest is a station, so each row in the final table describes a station. The dataset contains one dependent variable, one category variable, and two descriptors about each station. Each station stop is described by its ID in the TriMet system as well as the name of the station, which is typically related to its location in some way. Transit centers and street intersections are common name formats. Each station has associated with it a combined usage number across all the routes that stop there, including both onboardings and disembarkings. This usage total acts as our dependent variable. Independent variables engineered from the schedule data (see <em>Feature Engineering</em>) are as follows: number of routes that stop at the station, the earliest and latest arrivals at that station, the number of unique vehicles that arrive at the station over the course of the day, and the average number of minutes between arrivals. These values are calculated for both weekdays and weekend days, since the schedules can vary between weekdays and the weekend. Some routes do not run on the weekends, and thus only have weekday information given. Weekday information has a Boolean day value of 0, and weekend information has a value of 1.</p>
</section>
<section id="methods" class="level1">
<h1>Methods</h1>
<section id="data-collection-and-manipulation" class="level2">
<h2 class="anchored" data-anchor-id="data-collection-and-manipulation">Data Collection and Manipulation</h2>
<section id="pdf-data-extraction-and-webscraping" class="level3">
<h3 class="anchored" data-anchor-id="pdf-data-extraction-and-webscraping">PDF Data Extraction and Webscraping</h3>
<p>Data used for this project was available publicly through TriMet’s website, though in several different forms. This required a number of ingestion strategies.</p>
<p>Usage data was provided in a number of quarterly report PDFs on the TriMet website, which were then ingested and processed to extract the data. Each page in the PDF represented a single route, on a single day, going a single direction. It listed each station along the path, with its usage numbers over the entirety of Spring 2025. Trimet only releases their usage numbers for Spring and Fall, so this is effectively half a year’s worth of data. The PDFs were originally partitioned into Weekday, Saturday, and Sunday documents, but we would eventually combine the Saturday and Sunday schedules into a single “weekend” category.</p>
<p>Information about TriMet schedules was, however, slightly more complicated. Schedules as posted on the TriMet website under their Schedules tab only listed a small subset of the station stops that are present in the usage reports. Thankfully, TriMet also has their schedules listed by station, searchable by station ID number. This meant that once a list of IDs had been collected from the PDF reports, those IDs could be cross-referenced with the station schedules to obtain the raw schedule data for our many stops of interest, rather than a tenth of them.</p>
</section>
<section id="database-construction" class="level3">
<h3 class="anchored" data-anchor-id="database-construction">Database Construction</h3>
<p>The data was organized into four tables: stations, routes, schedule, and usage. Even though the schedules and usage were already separated, we needed to ensure that the route names, station names, and station ids all matched between files. For these reasons, we used an R script to prepare the data for ingestion into the Postgres database. The output was another four csv files that would each correspond to one of the database tables and could be copied in directly. Below (Figure 3) is an Entity Relationship Diagram showing our database organization:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="erd.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure 3: Entity Relationship Diagram for the database constructed in this project."><img src="erd.png" class="img-fluid figure-img" alt="Figure 3: Entity Relationship Diagram for the database constructed in this project."></a></p>
<figcaption>Figure 3: Entity Relationship Diagram for the database constructed in this project.</figcaption>
</figure>
</div>
<p>Stations and routes each have their own table, and are connected by two junction tables, schedule and usage. Each route is defined as a series of stations going a specific direction on a specific day. The usage table gives a total usage statistic for a specific station on a specific route. Alternatively, you can use the usage_id to select a station-route combination. This is useful within the schedule table, where the same route_id and station_id can have multiple arrival times in a schedule. This ensures third normal form because each table has a primary key and each non-key attribute depends solely on the key.</p>
</section>
<section id="feature-engineering" class="level3">
<h3 class="anchored" data-anchor-id="feature-engineering">Feature Engineering</h3>
<p>Each station has a large number of arrival times from a varying number of routes. However, arrival time alone makes for a poor feature. In pursuit of better features, a number of values were engineered from the schedule data for each station stop: the number of unique routes that stop at the station, the earliest and latest times the station is used, the number of vehicles that stop at the station over the course of the day, and the average number of minutes separating arrivals at the station. These values are all calculated for each station on both weekdays and weekend days. This was done overall by selecting the arrivals at each station on a given day and counting or otherwise manipulating the data into the features of interest. The total usage number sums for each station were also calculated at this stage, since usage information was originally provided at the route level for each station.</p>
</section>
</section>
<section id="statistical-modeling" class="level2">
<h2 class="anchored" data-anchor-id="statistical-modeling">Statistical Modeling</h2>
<p>This project used Poisson regression to model station usage as a function of the engineered features. The log of the usage values had to be used, as there are a number of TriMet routes (specifically, the MAX lines) that have usage numbers that could be considered outliers, while still being important data points in our analysis.</p>
<p>It’s possible that Poisson regression is not the correct statistical model to use for our data, since one of its assumptions is equidispersion. Due to the strength of the MAX lines, our data is heavily right skewed with a wildly differing mean and variance.</p>
</section>
<section id="machine-learning" class="level2">
<h2 class="anchored" data-anchor-id="machine-learning">Machine Learning</h2>
<p>This project used a number of machine learning models in an attempt to predict station usage numbers from the engineered features described earlier in this paper. The models investigated increased in complexity from standard linear regression through a variety of Support Vector Machine kernels to random forest regression. Random forest models were determined to have the best performance on this dataset, and thus were chosen to conduct a more in-depth analysis. Principal component analysis (PCA) was also used, for a small gain.</p>
<p>Because of the distribution of the usage data, a number of models were produced: one model covering the whole dataset, as well as sub-models for four determined data categories. As can be seen in Figure 3, usage values are a very uneven distribution.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="capstone_files/figure-html/unnamed-chunk-8-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure 3: Usage distributions for each station type. Note that the y-axis (Number of Stations) is not fixed, and that there are many more bus stations than MAX or WES Stations. There are only 6 WES stations in this dataset, and as such they were combined with the bus stations in the analysis."><img src="capstone_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672" alt="Figure 3: Usage distributions for each station type. Note that the y-axis (Number of Stations) is not fixed, and that there are many more bus stations than MAX or WES Stations. There are only 6 WES stations in this dataset, and as such they were combined with the bus stations in the analysis."></a></p>
<figcaption>Figure 3: Usage distributions for each station type. Note that the y-axis (Number of Stations) is <em>not</em> fixed, and that there are many more bus stations than MAX or WES Stations. There are only 6 WES stations in this dataset, and as such they were combined with the bus stations in the analysis.</figcaption>
</figure>
</div>
</div>
</div>
<p>The libraries used for this analysis were not able to find successful regressions for log-transformed usage data, which meant the data was split into four sub-categories: the data for MAX stations, as well as three categories of bus and WES station usage data (low, medium, and high). The distributions of the bus station data are shown in Figures 4 and 5, below. Low-usage bus stations are the majority of the data in this dataset, defined as stations with usage numbers between 0 and 30. Medium-usage stations have usage numbers between 30 and 300. Finally, there are a handful of stations with usage numbers over 300, which were filed as high-usage stations. These high-usage stations would commonly be considered outliers, but they are also the stations that the most people are using in the TriMet system, so it did not feel right to exclude them from the analysis.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="capstone_files/figure-html/unnamed-chunk-9-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure 4: Usage histograms showing the constructed bus usage categories. Note the y-axis (Number of Stations) is not fixed, and that the majority of the data is in the low-usage category."><img src="capstone_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672" alt="Figure 4: Usage histograms showing the constructed bus usage categories. Note the y-axis (Number of Stations) is not fixed, and that the majority of the data is in the low-usage category."></a></p>
<figcaption>Figure 4: Usage histograms showing the constructed bus usage categories. Note the y-axis (Number of Stations) is <em>not</em> fixed, and that the majority of the data is in the low-usage category.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="capstone_files/figure-html/unnamed-chunk-10-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure 5: Usage boxplots showing the constructed bus usage categories. Note the scale is not fixed."><img src="capstone_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672" alt="Figure 5: Usage boxplots showing the constructed bus usage categories. Note the scale is not fixed."></a></p>
<figcaption>Figure 5: Usage boxplots showing the constructed bus usage categories. Note the scale is <em>not</em> fixed.</figcaption>
</figure>
</div>
</div>
</div>
<p>As mentioned, random forest models were the main models used in this project. These random forests were limited to 10 trees and a tune length of 5, and trained using 3-fold cross-validation. The inputs given to each model as independent variables were the number of unique routes that stop at the station, the earliest and latest times the station is used, the number of vehicles that stop at the station over the course of the day, and the average number of minutes separating arrivals at the station, as well as a Boolean value for day of the week. In cases where PCA was used, all PCA transformations of these variables were used as inputs to the model. The models discussed in this paper will be those trained on PCA values, as there was found to be slight improvement when PCA was used over the raw values. The exception to this rule is the high-usage bus station data, as it was a small enough dataset the PCA transformations had no effect.</p>
</section>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<section id="statistical-modeling-1" class="level2">
<h2 class="anchored" data-anchor-id="statistical-modeling-1">Statistical Modeling</h2>
<p>We first created a model with all of our available features: Number of routes, number of arrivals, earliest arrival, latest arrival, average arrival difference, and day. The summary of the model shows that many of these features have negligible effects on the response variable. Since the poisson regression logs the data by default, we take the exponent of our summary statistics to interpret the data. The most salient feature was day, which tells us that usage can be expected to drop by around 8% on weekends.</p>
<p>Another model uses only the number of routes feature. This performed only slightly better. The summary shows that with each additional route to a particular station, we can expect the usage to increase by roughly 50%. However, after checking the validity of this through exploratory data analysis, we aren’t confident in the model’s accuracy. The majority of stations have less than five routes and the highest usage numbers are recorded there.</p>
</section>
<section id="machine-learning-1" class="level2">
<h2 class="anchored" data-anchor-id="machine-learning-1">Machine Learning</h2>
<p>The first model of interest to this paper is the random forest trained on the entire dataset with no segmentation. The full results of this model are shown in Figure 6, and a zoomed-in version is available in Figure 7. This model had an RMSE value of 79.74, which normalized to 0.0395, and an R^2 value during training of 0.3864.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="capstone_files/figure-html/unnamed-chunk-13-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure 6: Predicted values vs test values for the random forest model trained on the full PCA dataset, as well as the residuals. This model had an RMSE value of 79.74, but the shape of the residuals shows it is not a good model."><img src="capstone_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672" alt="Figure 6: Predicted values vs test values for the random forest model trained on the full PCA dataset, as well as the residuals. This model had an RMSE value of 79.74, but the shape of the residuals shows it is not a good model."></a></p>
<figcaption>Figure 6: Predicted values vs test values for the random forest model trained on the full PCA dataset, as well as the residuals. This model had an RMSE value of 79.74, but the shape of the residuals shows it is not a good model.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="capstone_files/figure-html/unnamed-chunk-14-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure 7: Predicted values vs test values for the random forest model trained on the full PCA dataset, as well as the residuals, limited to usage values between 0 and 100. This is a crop of Figure 6 for clarity of image."><img src="capstone_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672" alt="Figure 7: Predicted values vs test values for the random forest model trained on the full PCA dataset, as well as the residuals, limited to usage values between 0 and 100. This is a crop of Figure 6 for clarity of image."></a></p>
<figcaption>Figure 7: Predicted values vs test values for the random forest model trained on the full PCA dataset, as well as the residuals, limited to usage values between 0 and 100. This is a crop of Figure 6 for clarity of image.</figcaption>
</figure>
</div>
</div>
</div>
<p>Given the low metrics of the model trained on the full dataset, the next step in this analysis was to run the same model on each section of the dataset: MAX stations and usage-segmented bus stations. The results of the random forest trained on MAX station data are illustrated in Figure 8. This model had a test RMSE of 378.91, which normalizes to 0.188. The R^2 value during training of this model was 0.207. Surprisingly, this model performed worse than the full-data model, despite having a better distribution of usage data. This is likely because MAX stations are a minority in the dataset and thus the model does not have a large number of values to work with.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="capstone_files/figure-html/unnamed-chunk-15-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Figure 8: Predicted values vs test values for the random forest model trained on the MAX PCA dataset, as well as the residuals. This model had an RMSE value of 378.91."><img src="capstone_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672" alt="Figure 8: Predicted values vs test values for the random forest model trained on the MAX PCA dataset, as well as the residuals. This model had an RMSE value of 378.91."></a></p>
<figcaption>Figure 8: Predicted values vs test values for the random forest model trained on the MAX PCA dataset, as well as the residuals. This model had an RMSE value of 378.91.</figcaption>
</figure>
</div>
</div>
</div>
<p>Finally were the three models trained on bus station data. The WES train stations are included in these models, since there are only six WES stations in the TriMet system and the usage numbers aligned with those of the bus stations.</p>
<p>The results of the random forest trained on low-usage stations is illustrated in Figure 9. This model had a test RMSE of 5.965, which normalizes to 0.202. It had an R^2 value during testing of 0.313. This model contains the majority of the data in this dataset, and so it is not surprising that it closely reflects the results of the model trained on the full dataset. However, it is still not particularly accurate, as can be seen in the graphs in Figure X–specifically the residuals graph.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="capstone_files/figure-html/unnamed-chunk-16-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure 9: Predicted values vs test values for the random forest model trained on the low-usage bus PCA dataset, as well as the residuals. This model had an RMSE value of 5.965."><img src="capstone_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672" alt="Figure 9: Predicted values vs test values for the random forest model trained on the low-usage bus PCA dataset, as well as the residuals. This model had an RMSE value of 5.965."></a></p>
<figcaption>Figure 9: Predicted values vs test values for the random forest model trained on the low-usage bus PCA dataset, as well as the residuals. This model had an RMSE value of 5.965.</figcaption>
</figure>
</div>
</div>
</div>
<p>The model trained on medium-usage bus stations suffers in the same way the model for MAX stations does: the majority of the dataset is low-usage stations, leaving a much smaller dataset for the medium-usage model. The results of this model are illustrated in Figure 10. It had a test RMSE of 47.797, which normalizes to 0.177. The R^2 value of this model during testing was 0.085, which is the worst so far. This performance is represented in Figure X, particularly in the shape of the residuals.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="capstone_files/figure-html/unnamed-chunk-17-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Figure 10: Predicted values vs test values for the random forest model trained on the medium-usage bus PCA dataset, as well as the residuals. This model had an RMSE value of 47.797."><img src="capstone_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672" alt="Figure 10: Predicted values vs test values for the random forest model trained on the medium-usage bus PCA dataset, as well as the residuals. This model had an RMSE value of 47.797."></a></p>
<figcaption>Figure 10: Predicted values vs test values for the random forest model trained on the medium-usage bus PCA dataset, as well as the residuals. This model had an RMSE value of 47.797.</figcaption>
</figure>
</div>
</div>
</div>
<p>While it felt incomplete to exclude the high-usage stations from our project, the very small percentage of data points in this category is once again reflected in the performance of the model trained on the high-usage bus station data. These results are illustrated in Figure 11. This model had a test RMSE of 195.85, which normalizes to 0.898. This model had an R^2 value of 0.2326 during testing. While these metrics are relatively good compared to the other models constructed for this analysis, they are not particularly generalizable or actionable, given the incredibly small amount of data that produced this regression.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="capstone_files/figure-html/unnamed-chunk-18-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Figure 11: Predicted values vs test values for the random forest model trained on the high-usage bus PCA dataset, as well as the residuals. This model had an RMSE value of 195.85. Note the very low number of datapoints, which makes this model a poor generalization."><img src="capstone_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672" alt="Figure 11: Predicted values vs test values for the random forest model trained on the high-usage bus PCA dataset, as well as the residuals. This model had an RMSE value of 195.85. Note the very low number of datapoints, which makes this model a poor generalization."></a></p>
<figcaption>Figure 11: Predicted values vs test values for the random forest model trained on the high-usage bus PCA dataset, as well as the residuals. This model had an RMSE value of 195.85. Note the very low number of datapoints, which makes this model a poor generalization.</figcaption>
</figure>
</div>
</div>
</div>
<p>Overall, the model trained on the full dataset performed the best. The best in this case, however, was an R^2 value of 0.3–which is not very high, and thus these models cannot be considered highly predictive models. The best they’re doing is making it into the neighborhood, with RMSE values typically similar to the mean value of usage for each dataset. Interestingly, each bus model has visually similar results to the chunk of the full model that each model covers. This suggests that the full model’s accuracy is driven mainly by the low-usage bus data, which is to be expected: the low-usage bus data is the majority of data available in the dataset.</p>
</section>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>Over the course of this project, we went through the data collection and engineering process as well as modeling usage using statistical and machine learning-based regressions. Two types of data were collected from the TriMet website: usage information by station for Spring 2025, and schedule information for each station. These values were uploaded into a database, as well as transformed into a number of features for use in predicting the usage value of a station.</p>
<p>We experimented with multiple Poisson regression models, but ultimately weren’t able to generate accurate predictions. Plotting usage against predicted usage shows a scatterplot of points randomly spread on either side of the y=x diagonal line. Additionally, the summary of the model shows that each variable has negligible effects on usage. It’s possible that a different statistical model should be used, but more likely that the features we created are simply not good predictors of usage.</p>
<p>A number of random forest models were used to predict usage, at a number of scales. Usage was predicted over the full dataset, as well as for several categories: MAX stations, low-usage bus stations, medium-usage bus stations, and high-usage bus stations. Of these models, the one trained on the full dataset had the highest metrics, with an R^2 value during training of [FINAL VALUE]. The models trained on smaller proportions of the dataset performed worse than this full model, while the low-usage bus station model was comparable, due to its status as containing the majority of the data in the dataset. However, with a test RMSE value of [80-ISH, GET FINAL VALUE], even the highest-performing model does not make a good predictor for a dataset with a mean of 30.</p>
<section id="future-work" class="level2">
<h2 class="anchored" data-anchor-id="future-work">Future Work</h2>
<p>In some ways, the fact that schedule information alone is not particularly predictive of usage is not a surprising discovery. Future work done on this problem would benefit highly from the inclusion of location data for each station stop, which was unfortunately not easily available within the timeframe of this project. Potential inclusions beyond merely location data could be information that provides context to the neighborhood the station is in: how many people live within a certain radius, is this station part of a transit center or not, is there parking available nearby? And other possible questions that would allow for a holistic understanding of the station, rather than merely focusing on the schedule as set up by TriMet.</p>
<p>[SUGGESTED GRAPH: TOP AND BOTTOM 5 USAGE STOPS BY LOCATION. ADD PORTLAND MAP WITH POPULATION DISTRICTS?]</p>
</section>
<section id="in-conclusion" class="level2">
<h2 class="anchored" data-anchor-id="in-conclusion">In Conclusion</h2>
<p>All in all, this was a high-level analysis of TriMet usage data. We provide a database of usage data by station for Spring 2025, which also includes schedule information for each stop. This data was used to engineer a handful of features that were used to predict usage numbers, but the resulting predictions were not particularly high-scoring on any of the accuracy metrics investigated. Future work that provides location context to stations is likely to improve our ability to predict TriMet station usage.</p>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<div id="refs" role="list">

</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>